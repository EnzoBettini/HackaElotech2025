<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Saúde ProAtivo - Painel de Campanhas</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Montserrat:wght@600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #0A3D62;
            --secondary-color: #2C3E50;
            --accent-color: #E67E22;
            --highlight-color: #1ABC9C;
            --danger-color: #E74C3C;
            --warning-color: #F39C12;
            --info-color: #3498DB;
            --success-color: #2ECC71;

            --text-light: #F8F9FA;
            --text-dark: #343A40;
            --bg-light: #FFFFFF;
            --bg-medium: #ECF0F1;
            --border-color: #D1D8E0;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-medium);
            color: var(--text-dark);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar (Estilo do Dashboard Principal) */
        .sidebar {
            width: 260px;
            background-color: var(--secondary-color);
            color: var(--text-light);
            padding: 20px 0;
            transition: width 0.3s ease, padding 0.3s ease;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar.collapsed {
            width: 70px;
            padding: 20px 0;
        }

        .sidebar-header {
            padding: 0 20px 20px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 10px;
        }

        .sidebar-header .logo-icon {
            font-size: 1.8em;
            color: var(--highlight-color);
        }

        .sidebar-header h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1em;
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform: translateX(0);
        }

        .sidebar-header h1 .proativo {
            color: var(--highlight-color);
            font-weight: 700;
        }

        .sidebar.collapsed .sidebar-header h1 {
            opacity: 0;
            display: none;
            transform: translateX(-20px);
        }

        .sidebar-toggle {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.2em;
            cursor: pointer;
            padding: 10px 20px;
            text-align: left;
            width: 100%;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-toggle .fa-bars-staggered,
        .sidebar-toggle .fa-bars {
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .sidebar-toggle .fa-bars-staggered {
            display: none;
        }

        .sidebar.collapsed .sidebar-toggle .fa-bars {
            display: inline-block;
            margin: 0 auto;
        }

        .sidebar .sidebar-toggle .fa-bars {
            display: none;
        }

        .nav-menu ul {
            list-style: none;
        }

        .nav-menu li a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--text-light);
            text-decoration: none;
            font-size: 0.95em;
            white-space: nowrap;
            transition: background-color 0.2s ease, padding-left 0.3s ease;
        }

        .nav-menu li a:hover,
        .nav-menu li a.active {
            background-color: rgba(255, 255, 255, 0.15);
        }

        .nav-menu li a .nav-icon {
            width: 20px;
            text-align: center;
            margin-right: 15px;
            font-size: 1.1em;
        }

        .sidebar.collapsed .nav-menu li a {
            padding-left: 25px;
        }

        .sidebar.collapsed .nav-menu li a .nav-text {
            opacity: 0;
            display: none;
        }

        .sidebar.collapsed .nav-menu li a .nav-icon {
            margin-right: 0;
        }

        /* Main Content & Top Header (Estilo do Dashboard Principal) */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .top-header {
            background-color: var(--bg-light);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .top-header h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5em;
            color: var(--primary-color);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-profile .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            color: var(--primary-color);
        }

        .user-profile span {
            font-weight: 500;
        }

        /* Dashboard Area (Estilo Base do Dashboard Principal) */
        .dashboard-area {
            flex-grow: 1;
            padding: 20px 30px;
            overflow-y: auto;
        }

        /* Estilos de Componentes Genéricos (Botões, Cards, Modais - do Dashboard Principal) */
        .btn {
            padding: 10px 15px;
            font-size: 0.9em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, filter 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            justify-content: center;
            font-weight: 500;
        }

        .btn:hover {
            filter: brightness(110%);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-accent {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8em;
        }

        /* NOVO PAINEL DE CAMPANHAS */
        .campaign-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .campaign-panel-header h3 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
            font-size: 1.4em;
            margin: 0;
        }

        .campaign-section {
            margin-bottom: 30px;
        }

        .campaign-section-title {
            font-size: 1.2em;
            color: var(--secondary-color);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--highlight-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .campaign-section-title a.view-all-link {
            font-size: 0.8em;
            font-weight: 500;
            color: var(--primary-color);
            text-decoration: none;
        }

        .campaign-section-title a.view-all-link:hover {
            text-decoration: underline;
        }

        .active-campaigns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .active-campaign-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
            border-left: 5px solid var(--success-color);
            /* Destaque para ativas */
        }

        .active-campaign-card-header {
            padding: 15px 20px;
        }

        .active-campaign-card-header h4 {
            font-size: 1.2em;
            color: var(--primary-color);
            margin: 0 0 5px 0;
        }

        .active-campaign-card-header p {
            font-size: 0.85em;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }

        .active-campaign-card-main {
            padding: 0 20px 20px 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .active-campaign-card-main .info {
            flex-grow: 1;
            font-size: 0.9em;
        }

        .active-campaign-card-main .info p {
            margin-bottom: 6px;
        }

        .active-campaign-card-main .info .label {
            font-weight: 500;
        }

        .active-campaign-card-main .progress-chart-container {
            width: 90px;
            height: 90px;
        }

        .active-campaign-card-footer {
            padding: 12px 20px;
            background-color: var(--bg-medium);
            border-top: 1px solid var(--border-color);
            text-align: right;
        }

        .compact-campaign-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .compact-campaign-card {
            background-color: #fff;
            border-radius: 6px;
            padding: 15px;
            box-shadow: var(--shadow-sm);
            font-size: 0.9em;
        }

        .compact-campaign-card h5 {
            font-size: 1em;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .compact-campaign-card p {
            margin-bottom: 4px;
            color: var(--text-dark);
        }

        .compact-campaign-card .label {
            font-weight: 500;
        }

        .compact-campaign-card .campaign-date {
            font-size: 0.85em;
            color: var(--secondary-color);
        }

        .compact-campaign-card.suggestion-card {
            border-left: 4px solid var(--accent-color);
        }

        .compact-campaign-card.concluded-card {
            border-left: 4px solid var(--secondary-color);
            opacity: 0.85;
        }

        .compact-campaign-card .btn-sm {
            margin-top: 8px;
        }

        .placeholder-section {
            text-align: center;
            padding: 30px 20px;
            color: #777;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
        }

        .placeholder-section i {
            font-size: 2em;
            margin-bottom: 10px;
            color: var(--border-color);
        }


        /* Modal de Campanha (mesmo da versão anterior, mas referenciado) */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background-color: var(--bg-light);
            padding: 30px;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            width: 90%;
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
        }

        .modal-content.modal-xl {
            max-width: 1100px;
        }

        /* Usado pelo modal de campanha */
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2em;
            color: var(--text-dark);
            cursor: pointer;
            line-height: 1;
            padding: 5px;
        }

        .modal-close-btn:hover {
            color: var(--danger-color);
        }

        .modal-content .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-content .modal-header h3 {
            color: var(--primary-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-campaign-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: var(--secondary-color);
        }

        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.95em;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .actions-list-editor ul {
            list-style: none;
            padding: 0;
        }

        .actions-list-editor li {
            display: grid;
            grid-template-columns: 3fr 1.5fr 1.5fr 1.5fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .actions-list-editor input,
        .actions-list-editor select {
            width: 100%;
            padding: 8px;
            font-size: 0.9em;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .actions-list-editor .btn-danger {
            padding: 5px 8px;
        }

        #campaignFocusMapContainer {
            height: 250px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            margin-top: 10px;
        }

        .chart-container-modal {
            height: 220px;
        }

        .modal-content .modal-footer {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            text-align: right;
        }

        .ia-justification-box {
            background-color: var(--bg-medium);
            border-left: 4px solid var(--accent-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .ia-justification-box h5 {
            margin-top: 0;
            color: var(--accent-color);
            font-family: 'Montserrat';
        }

        .ia-justification-box p {
            font-size: 0.9em;
            line-height: 1.5;
        }

        /* Estilo para status da ação no modal */
        .action-status-display {
            padding: 3px 8px;
            border-radius: 10px;
            color: white;
            font-size: 0.85em;
            text-align: center;
        }

        .action-status-planejada {
            background-color: var(--info-color);
        }

        .action-status-em_andamento {
            background-color: var(--highlight-color);
        }

        .action-status-concluida {
            background-color: var(--success-color);
        }

        .action-status-atrasada {
            background-color: var(--warning-color);
        }

        .action-status-cancelada {
            background-color: var(--danger-color);
        }


        /* Responsividade */
        @media (max-width: 992px) {
            .active-campaigns-grid {
                grid-template-columns: 1fr;
            }

            .actions-list-editor li {
                grid-template-columns: 1fr;
                /* Stack em telas menores */
            }

            .actions-list-editor li>* {
                margin-bottom: 5px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .sidebar.collapsed {
                width: 100%;
            }

            .main-content {
                height: auto;
            }

            .top-header {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }

            .top-header h2 {
                font-size: 1.3em;
            }

            .dashboard-area {
                padding: 15px;
            }

            .campaign-panel-header {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }

            .campaign-panel-header .btn {
                margin-top: 10px;
                width: 100%;
            }

            .compact-campaign-list {
                grid-template-columns: 1fr;
            }

            .modal-campaign-form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-heart-pulse logo-icon"></i>
            <h1>Diagno<span class="proativo">Map</span></h1>
        </div>
        <button class="sidebar-toggle" id="sidebarToggleBtn">
            <i class="fas fa-bars-staggered"></i><i class="fas fa-bars"></i> <span class="nav-text">Recolher</span>
        </button>
        <nav class="nav-menu">
            <ul>
                <li><a href="dashboard.html"><i class="fas fa-tachometer-alt nav-icon"></i> <span
                            class="nav-text">Dashboard Principal</span></a></li>
                <li><a href="vigilancia_epidemiologica.html"><i class="fas fa-head-side-virus nav-icon"></i> <span
                            class="nav-text">Vigilância Epidemiológica</span></a></li>
                <li><a href="gestao_recursos.html"><i class="fas fa-users-cog nav-icon"></i> <span
                            class="nav-text">Gestão de Recursos</span></a></li>
                <li><a href="unidades_saude.html"><i class="fas fa-hospital-user nav-icon"></i> <span
                            class="nav-text">Unidades de Saúde</span></a></li>
                <li><a href="analises_ia.html"><i class="fas fa-chart-pie nav-icon"></i> <span class="nav-text">Análises
                            e IA</span></a></li>
                <li><a href="#" class="active"><i class="fas fa-bullhorn nav-icon"></i> <span
                            class="nav-text">Campanhas</span></a></li>
                <li><a href="alertas_criticos.html"><i class="fas fa-bell nav-icon"></i> <span class="nav-text">Alertas
                            Críticos</span></a></li>
                <li><a href="relatorios.html"><i class="fas fa-file-medical-alt nav-icon"></i> <span
                            class="nav-text">Relatórios</span></a></li>
                <li><a href="../index.html"><i class="fas fa-solid fa-rotate-left nav-icon"></i> <span class="nav-text">Voltar ao
                            menu</span></a></li>
            </ul>
        </nav>
        <div style="margin-top: auto; padding: 0 20px 20px 20px;">
            <a href="#"
                style="display: flex; align-items: center; padding: 12px 0; color: var(--text-light); text-decoration: none; font-size: 0.95em; white-space: nowrap;">
                <i class="fas fa-cog nav-icon"></i> <span class="nav-text">Configurações</span>
            </a>
        </div>
    </aside>

    <div class="main-content">
        <header class="top-header">
            <h2>Painel de Gestão de Campanhas</h2>
            <div class="user-profile">
                <div class="avatar"><i class="fas fa-user-tie"></i></div>
                <span>Marcelo (Secretário de Saúde Municipal)</span>
            </div>
        </header>

        <main class="dashboard-area">
            <div class="campaign-panel-header">
                <h3>Acompanhamento de Iniciativas de Saúde</h3>
                <button class="btn btn-primary" id="btnNovaCampanha"><i class="fas fa-plus-circle"></i> Criar Nova
                    Campanha</button>
            </div>

            <section class="campaign-section">
                <h4 class="campaign-section-title">
                    <span><i class="fas fa-play-circle" style="color:var(--success-color)"></i> Campanhas Ativas</span>
                    <a href="#" class="view-all-link" data-status-filter="ativa">Ver todas (<span
                            id="countAtivasPanel">0</span>)</a>
                </h4>
                <div class="active-campaigns-grid" id="activeCampaignsContainer">
                </div>
                <div id="noActiveCampaigns" class="placeholder-section" style="display:none;">
                    <i class="fas fa-calendar-check"></i>
                    <p>Nenhuma campanha ativa no momento.</p>
                </div>
            </section>

            <section class="campaign-section">
                <h4 class="campaign-section-title">
                    <span><i class="fas fa-calendar-alt" style="color:var(--info-color)"></i> Próximas Campanhas
                        (Planejadas)</span>
                    <a href="#" class="view-all-link" data-status-filter="planejada">Ver todas (<span
                            id="countPlanejadasPanel">0</span>)</a>
                </h4>
                <div class="compact-campaign-list" id="plannedCampaignsContainer">
                </div>
                <div id="noPlannedCampaigns" class="placeholder-section" style="display:none;">
                    <i class="fas fa-hourglass-start"></i>
                    <p>Nenhuma campanha planejada para iniciar em breve.</p>
                </div>
            </section>

            <section class="campaign-section">
                <h4 class="campaign-section-title">
                    <span><i class="fas fa-lightbulb" style="color:var(--accent-color)"></i> Sugestões da IA para Novas
                        Campanhas</span>
                    <a href="#" class="view-all-link" data-status-filter="sugerida">Ver todas (<span
                            id="countSugeridasPanel">0</span>)</a>
                </h4>
                <div class="compact-campaign-list" id="suggestedCampaignsContainer">
                </div>
                <div id="noSuggestedCampaigns" class="placeholder-section" style="display:none;">
                    <i class="fas fa-magic"></i>
                    <p>Nenhuma nova sugestão da IA no momento.</p>
                </div>
            </section>

            <section class="campaign-section">
                <h4 class="campaign-section-title">
                    <span><i class="fas fa-history" style="color:var(--secondary-color)"></i> Histórico de
                        Campanhas</span>
                    <a href="#" class="view-all-link" data-status-filter="concluida">Acessar Campanhas Concluídas (<span
                            id="countConcluidasPanel">0</span>)</a>
                </h4>
                <div class="compact-campaign-list" id="concludedCampaignsContainer"
                    style="max-height: 200px; overflow-y: auto;">
                </div>
                <div id="noConcludedCampaigns" class="placeholder-section" style="display:none;">
                    <i class="fas fa-archive"></i>
                    <p>Ainda não há campanhas concluídas registradas.</p>
                </div>
            </section>

        </main>
    </div>

    <div class="modal-overlay" id="campaignDetailModal">
        <div class="modal-content modal-xl">
            <button class="modal-close-btn" data-modal-id="campaignDetailModal">&times;</button>
            <div class="modal-header">
                <h3 id="modalCampaignTitle"><i class="fas fa-bullhorn"></i> Nova Campanha</h3>
            </div>
            <form id="campaignForm">
                <input type="hidden" id="campaignId">
                <div class="modal-body">
                    <div id="iaJustificationContainer" class="ia-justification-box" style="display:none;">
                        <h5><i class="fas fa-brain"></i> Justificativa da IA para esta Sugestão:</h5>
                        <p id="iaJustificationText"></p>
                    </div>

                    <div class="modal-campaign-form-grid">
                        <section>
                            <h4><i class="fas fa-info-circle"></i> Informações Básicas</h4>
                            <div class="form-group">
                                <label for="campaignName">Nome da Campanha:</label>
                                <input type="text" id="campaignName" required>
                            </div>
                            <div class="form-group">
                                <label for="campaignType">Tipo:</label>
                                <select id="campaignType">
                                    <option value="vacinacao">Vacinação</option>
                                    <option value="prevencao">Prevenção de Doenças</option>
                                    <option value="conscientizacao">Conscientização</option>
                                    <option value="rastreamento">Rastreamento/Triagem</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="campaignObjective">Objetivo Principal:</label>
                                <textarea id="campaignObjective" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="campaignDoencaAgravo">Doença/Agravo Alvo (opcional):</label>
                                <input type="text" id="campaignDoencaAgravo" placeholder="Ex: Dengue, Hipertensão">
                            </div>
                        </section>
                        <section>
                            <h4><i class="fas fa-users"></i> Público-Alvo e Metas</h4>
                            <div class="form-group">
                                <label for="campaignPublicoAlvo">Descrição do Público-Alvo:</label>
                                <input type="text" id="campaignPublicoAlvo"
                                    placeholder="Ex: Idosos 60+, Crianças de 6m a 5a">
                            </div>
                            <div class="form-group">
                                <label for="campaignMetaPrincipal">Meta Principal (Quantitativa):</label>
                                <input type="text" id="campaignMetaPrincipal"
                                    placeholder="Ex: Vacinar 95% do público-alvo">
                            </div>
                            <div class="form-group">
                                <label for="campaignStartDate">Data de Início:</label>
                                <input type="date" id="campaignStartDate">
                            </div>
                            <div class="form-group">
                                <label for="campaignEndDate">Data de Término:</label>
                                <input type="date" id="campaignEndDate">
                            </div>
                            <div class="form-group">
                                <label for="campaignStatusModal">Status:</label>
                                <select id="campaignStatusModal">
                                    <option value="planejada">Planejada</option>
                                    <option value="ativa">Ativa</option>
                                    <option value="concluida">Concluída</option>
                                    <option value="cancelada">Cancelada</option>
                                </select>
                            </div>
                        </section>
                    </div>
                    <hr style="margin:20px 0;">
                    <div class="modal-campaign-form-grid">
                        <section>
                            <h4><i class="fas fa-tasks"></i> Plano de Ações Detalhado</h4>
                            <div class="actions-list-editor" id="actionsListEditor">
                                <ul>
                                </ul>
                            </div>
                            <button type="button" class="btn btn-sm btn-secondary" id="btnAddAction"><i
                                    class="fas fa-plus"></i> Adicionar Ação</button>
                        </section>
                        <section>
                            <h4><i class="fas fa-map-marked-alt"></i> Área Geográfica de Foco</h4>
                            <div id="campaignFocusMapContainer"></div>
                            <p style="font-size:0.8em; text-align:center;">(Mapa para selecionar/visualizar regiões de
                                foco - Simulado)</p>

                            <h4 style="margin-top:20px;"><i class="fas fa-chart-bar"></i> Acompanhamento (Progresso)
                            </h4>
                            <div class="form-group">
                                <label for="campaignProgresso">Progresso Atual (%):</label>
                                <input type="number" id="campaignProgresso" min="0" max="100" value="0">
                            </div>
                            <div class="chart-container-modal">
                                <canvas id="campaignProgressChart"></canvas>
                            </div>
                        </section>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close-btn-footer"
                        data-modal-id="campaignDetailModal"><i class="fas fa-times"></i> Fechar</button>
                    <button type="submit" class="btn btn-success" id="btnSalvarCampanha"><i class="fas fa-save"></i>
                        Salvar Campanha</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // --- JavaScript Base (Sidebar) ---
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        let campaignMap = null;
        let campaignProgressChartInstance = null;
        let activeCampaignCharts = {};

        sidebarToggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            setTimeout(() => {
                if (campaignMap) campaignMap.invalidateSize();
                if (campaignProgressChartInstance) campaignProgressChartInstance.resize();
                Object.values(activeCampaignCharts).forEach(chart => {
                    if (chart) chart.resize();
                });
            }, 310);
        });

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('active');

            if (modalId === 'campaignDetailModal') {
                if (campaignProgressChartInstance) {
                    campaignProgressChartInstance.destroy();
                    campaignProgressChartInstance = null;
                }
                if (campaignMap) {
                    campaignMap.remove();
                    campaignMap = null;
                }
                document.getElementById('iaJustificationContainer').style.display = 'none'; // Esconder justificativa
            }
        }

        document.querySelectorAll('.modal-close-btn, .modal-close-btn-footer').forEach(button => {
            button.addEventListener('click', function () {
                closeModal(this.dataset.modalId);
            });
        });
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function (event) {
                if (event.target === this) {
                    closeModal(this.id);
                }
            });
        });

        // --- JavaScript Específico da Página de Campanhas (Nova Abordagem) ---
        const btnNovaCampanha = document.getElementById('btnNovaCampanha');
        const campaignForm = document.getElementById('campaignForm');
        const modalCampaignTitle = document.getElementById('modalCampaignTitle');
        const actionsListEditorUl = document.querySelector('#actionsListEditor ul');
        const btnAddAction = document.getElementById('btnAddAction');
        const iaJustificationContainer = document.getElementById('iaJustificationContainer');
        const iaJustificationText = document.getElementById('iaJustificationText');

        const activeCampaignsContainer = document.getElementById('activeCampaignsContainer');
        const noActiveCampaigns = document.getElementById('noActiveCampaigns');
        const plannedCampaignsContainer = document.getElementById('plannedCampaignsContainer');
        const noPlannedCampaigns = document.getElementById('noPlannedCampaigns');
        const suggestedCampaignsContainer = document.getElementById('suggestedCampaignsContainer');
        const noSuggestedCampaigns = document.getElementById('noSuggestedCampaigns');
        const concludedCampaignsContainer = document.getElementById('concludedCampaignsContainer');
        const noConcludedCampaigns = document.getElementById('noConcludedCampaigns');

        let todasCampanhas = [
            // Campanhas Ativas
            { id: 'C001', nome: 'Vacinação Gripe 2025', tipo: 'vacinacao', status: 'ativa', publico: 'Idosos 60+, Crianças, Gestantes', periodo: '01/04/2025 - 30/06/2025', meta: '90% do público', progresso: 65, objetivo: 'Reduzir casos graves de gripe.', doencaAgravo: 'Gripe', acoes: [{ desc: 'Divulgação na mídia', prazo: '2025-04-15', status: 'concluida', responsavelSimulado: 'Secretaria de Comunicação' }, { desc: 'Dia D nos postos', prazo: '2025-05-10', status: 'planejada', responsavelSimulado: 'Coordenação de Imunização' }] },
            { id: 'C002', nome: 'Combate à Dengue - Verão Consciente', tipo: 'prevencao', status: 'ativa', publico: 'Toda a população, foco em áreas de risco', periodo: '01/12/2024 - 28/02/2025', meta: 'Reduzir focos do Aedes Aegypti em 50%', progresso: 80, objetivo: 'Diminuir incidência de Dengue, Zika e Chikungunya através da eliminação de criadouros.', doencaAgravo: 'Dengue, Zika, Chikungunya', acoes: [{ desc: 'Mutirões de limpeza semanais', prazo: '2025-01-30', status: 'concluida', responsavelSimulado: 'Vigilância Ambiental' }, { desc: 'Visitas domiciliares de agentes', prazo: '2025-02-15', status: 'em_andamento', responsavelSimulado: 'Agentes de Endemias' }] },
            { id: 'C009', nome: 'Saúde Mental Pós-Pandemia', tipo: 'conscientizacao', status: 'ativa', publico: 'Toda população, com foco em jovens', periodo: '15/03/2025 - 15/07/2025', meta: 'Aumentar procura por serviços de saúde mental em 20%', progresso: 30, objetivo: 'Promover o bem-estar mental e desmistificar a busca por ajuda psicológica.', doencaAgravo: 'Saúde Mental', acoes: [{ desc: 'Palestras em escolas e universidades', prazo: '2025-04-30', status: 'em_andamento', responsavelSimulado: 'Equipe CAPS' }, { desc: 'Linha de apoio telefônico 24h', prazo: '2025-03-15', status: 'ativa', responsavelSimulado: 'Voluntários Psicólogos' }] },

            // Campanhas Planejadas
            { id: 'C003', nome: 'Prevenção Câncer de Mama - Outubro Rosa 2025', tipo: 'rastreamento', status: 'planejada', publico: 'Mulheres de 40 a 69 anos', periodo: '01/10/2025 - 31/10/2025', meta: 'Realizar 500 mamografias gratuitas', progresso: 0, objetivo: 'Promover a detecção precoce do câncer de mama e conscientizar sobre a importância do autoexame.', doencaAgravo: 'Câncer de Mama', acoes: [{ desc: 'Agendamento de palestras em empresas e comunidades', prazo: '2025-09-15', status: 'planejada', responsavelSimulado: 'NASF' }, { desc: 'Parceria com clínicas para oferta de exames', prazo: '2025-09-30', status: 'planejada', responsavelSimulado: 'Gestão de Contratos' }] },
            { id: 'C005', nome: 'Saúde do Homem - Novembro Azul 2025', tipo: 'conscientizacao', status: 'planejada', publico: 'Homens acima de 40 anos', periodo: '01/11/2025 - 30/11/2025', meta: 'Aumentar procura por exames preventivos de próstata em 30%', progresso: 0, objetivo: 'Conscientizar sobre a importância da saúde masculina e prevenção do câncer de próstata.', doencaAgravo: 'Câncer de Próstata', acoes: [{ desc: 'Workshops em unidades de saúde sobre saúde masculina', prazo: '2025-10-20', status: 'planejada', responsavelSimulado: 'Equipes UBS' }] },
            { id: 'C006', nome: 'Programa de Controle da Hipertensão Arterial 2025', tipo: 'prevencao', status: 'planejada', publico: 'Adultos acima de 30 anos, com foco em não diagnosticados', periodo: '15/07/2025 - 15/09/2025', meta: 'Cadastrar 1000 novos pacientes no programa HiperDia', progresso: 0, objetivo: 'Identificar precocemente e acompanhar pacientes hipertensos, promovendo adesão ao tratamento.', doencaAgravo: 'Hipertensão Arterial', acoes: [] },

            // Campanhas Concluídas
            { id: 'C004', nome: 'Semana Saúde Bucal Escolar 2024', tipo: 'conscientizacao', status: 'concluida', publico: 'Crianças de 6 a 10 anos de escolas municipais', periodo: '15/03/2024 - 22/03/2024', meta: 'Alcançou 2200 crianças', progresso: 100, objetivo: 'Promoveu hábitos de higiene bucal e distribuiu kits de escovação.', doencaAgravo: 'Cárie Dentária', acoes: [{ desc: 'Palestras educativas em 15 escolas', prazo: '2024-03-18', status: 'concluida', responsavelSimulado: 'Dentistas da Rede' }, { desc: 'Distribuição de 2200 kits de higiene', prazo: '2024-03-22', status: 'concluida', responsavelSimulado: 'Secretaria de Educação' }] },
            { id: 'C007', nome: 'Vacinação Poliomielite e Multivacinação 2023', tipo: 'vacinacao', status: 'concluida', publico: 'Crianças menores de 5 anos', periodo: '01/08/2023 - 31/08/2023', meta: 'Cobertura de 96% para Pólio', progresso: 100, objetivo: 'Manteve erradicação da poliomielite e atualizou caderneta vacinal infantil.', doencaAgravo: 'Poliomielite, Sarampo, etc.', acoes: [] },
            { id: 'C008', nome: 'Prevenção de IST/AIDS - Carnaval Consciente 2024', tipo: 'prevencao', status: 'concluida', publico: 'Jovens e Adultos sexualmente ativos em locais de folia', periodo: '01/02/2024 - 15/02/2024', meta: 'Distribuiu 60.000 preservativos', progresso: 100, objetivo: 'Reduziu transmissão de ISTs durante o período festivo através da informação e oferta de insumos.', doencaAgravo: 'IST/AIDS', acoes: [] },

            // Campanhas Sugeridas pela IA
            { id: 'SIA001', nome: 'Sugestão IA: Vacinação Sarampo (Baixa Cobertura Região Norte)', tipo: 'vacinacao', status: 'sugerida', publico: 'Crianças 1-5 anos Região Norte', periodo: 'A definir', meta: 'Aumentar cobertura para 95%', progresso: 0, objetivo: 'Evitar surto de sarampo devido à baixa cobertura vacinal identificada pela IA.', doencaAgravo: 'Sarampo', justificativaIA: 'Nossos modelos identificaram uma queda preocupante de 15% na cobertura vacinal contra o sarampo na Região Norte nos últimos 6 meses, em comparação com a média municipal. Essa região também apresenta alta densidade populacional infantil e histórico de baixa adesão a campanhas anteriores. A previsão indica um risco 3x maior de surto localizado nesta região caso a cobertura não seja elevada rapidamente.', acoes: [{ desc: 'Busca ativa de não vacinados', prazo: '', status: 'sugerida', responsavelSimulado: 'Agentes Comunitários' }, { desc: 'Vacinação em creches/escolas da região', prazo: '', status: 'sugerida', responsavelSimulado: 'Equipes de Imunização' }] },
            { id: 'SIA002', nome: 'Sugestão IA: Prevenção Hipertensão (População Adulta Sedentária)', tipo: 'prevencao', status: 'sugerida', publico: 'Adultos 30-59 anos com histórico de sedentarismo e sobrepeso', periodo: 'A definir', meta: 'Reduzir novos diagnósticos de hipertensão em 5% em 12 meses', progresso: 0, objetivo: 'Incentivar atividade física e alimentação saudável para prevenir hipertensão em grupo de risco.', doencaAgravo: 'Hipertensão', justificativaIA: 'A análise de dados de prontuários eletrônicos e questionários de estilo de vida aponta que 40% dos adultos entre 30-59 anos são sedentários e apresentam sobrepeso, fatores de risco chave para hipertensão. Uma campanha focada em mudança de hábitos pode ter impacto significativo na prevenção primária.', acoes: [] },
            { id: 'SIA003', nome: 'Sugestão IA: Rastreamento de Diabetes em Idosos (Áreas Carentes)', tipo: 'rastreamento', status: 'sugerida', publico: 'Idosos acima de 60 anos em regiões com baixo acesso a serviços de saúde (Distritos X, Y)', periodo: 'A definir', meta: 'Identificar 100 novos casos de diabetes tipo 2', progresso: 0, objetivo: 'Diagnóstico precoce de diabetes em população vulnerável para início imediato do tratamento e prevenção de complicações.', doencaAgravo: 'Diabetes Tipo 2', justificativaIA: 'Cruzamento de dados socioeconômicos e de acesso a serviços mostra que os Distritos X e Y possuem a menor taxa de exames de glicemia em idosos. Modelos preditivos baseados em comorbidades e idade indicam uma alta probabilidade de casos não diagnosticados nessas áreas. Um rastreamento ativo é recomendado.', acoes: [] },
        ];

        function createMiniProgressChart(canvasId, progress) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return null;

            if (activeCampaignCharts[canvasId]) activeCampaignCharts[canvasId].destroy();

            activeCampaignCharts[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [progress, 100 - progress],
                        backgroundColor: [getComputedStyle(document.documentElement).getPropertyValue('--highlight-color').trim(), getComputedStyle(document.documentElement).getPropertyValue('--bg-medium').trim()],
                        borderWidth: 0,
                        circumference: 270,
                        rotation: -135
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    animation: { animateScale: false, animateRotate: false }
                }
            });
            return activeCampaignCharts[canvasId];
        }

        function renderActiveCampaigns(limit = 3) {
            const ativas = todasCampanhas.filter(c => c.status === 'ativa').slice(0, limit);
            activeCampaignsContainer.innerHTML = '';
            if (ativas.length === 0) {
                noActiveCampaigns.style.display = 'block';
                activeCampaignsContainer.style.display = 'none';
            } else {
                noActiveCampaigns.style.display = 'none';
                activeCampaignsContainer.style.display = 'grid';
                ativas.forEach(campaign => {
                    const chartId = `progressChart-${campaign.id}`;
                    const cardHTML = `
                        <div class="active-campaign-card" data-campaign-id="${campaign.id}">
                            <div class="active-campaign-card-header">
                                <h4>${campaign.nome}</h4>
                                <p>${campaign.objetivo.substring(0, 100)}${campaign.objetivo.length > 100 ? '...' : ''}</p>
                            </div>
                            <div class="active-campaign-card-main">
                                <div class="info">
                                    <p><span class="label">Público:</span> ${campaign.publico}</p>
                                    <p><span class="label">Período:</span> ${campaign.periodo}</p>
                                    <p><span class="label">Meta:</span> ${campaign.meta}</p>
                                </div>
                                <div class="progress-chart-container">
                                    <canvas id="${chartId}"></canvas>
                                    <p style="text-align:center; font-weight:bold; color:var(--highlight-color); margin-top:-55px; font-size:1.4em;">${campaign.progresso}%</p>
                                </div>
                            </div>
                            <div class="active-campaign-card-footer">
                                <button class="btn btn-sm btn-info btn-detalhes-campanha"><i class="fas fa-eye"></i> Detalhes</button>
                                <button class="btn btn-sm btn-secondary btn-editar-campanha"><i class="fas fa-edit"></i> Editar</button>
                            </div>
                        </div>
                    `;
                    activeCampaignsContainer.innerHTML += cardHTML;
                    setTimeout(() => createMiniProgressChart(chartId, campaign.progresso), 0);
                });
            }
            document.getElementById('countAtivasPanel').textContent = todasCampanhas.filter(c => c.status === 'ativa').length;
        }

        function renderCompactCampaigns(container, campaigns, typeClass = '', limit = 3) {
            container.innerHTML = '';
            const limitedCampaigns = campaigns.slice(0, limit);

            if (limitedCampaigns.length === 0) {
                const noCampaignsPlaceholder = container.nextElementSibling;
                if (noCampaignsPlaceholder && noCampaignsPlaceholder.classList.contains('placeholder-section')) {
                    noCampaignsPlaceholder.style.display = 'block';
                }
                container.style.display = 'none';
            } else {
                const noCampaignsPlaceholder = container.nextElementSibling;
                if (noCampaignsPlaceholder && noCampaignsPlaceholder.classList.contains('placeholder-section')) {
                    noCampaignsPlaceholder.style.display = 'none';
                }
                container.style.display = 'grid';
                limitedCampaigns.forEach(campaign => {
                    let buttonHTML = `<button class="btn btn-sm btn-info btn-detalhes-campanha"><i class="fas fa-eye"></i> Detalhes</button>`;
                    if (campaign.status === 'sugerida') {
                        buttonHTML = `<button class="btn btn-sm btn-accent btn-planejar-sugerida"><i class="fas fa-calendar-alt"></i> Planejar</button>`;
                    } else if (campaign.status !== 'concluida') { // Adicionar botão de editar para planejadas também
                        buttonHTML += ` <button class="btn btn-sm btn-secondary btn-editar-campanha"><i class="fas fa-edit"></i> Editar</button>`;
                    }


                    const cardHTML = `
                        <div class="compact-campaign-card ${typeClass}" data-campaign-id="${campaign.id}">
                            <h5>${campaign.nome}</h5>
                            <p><span class="label">Público:</span> ${campaign.publico}</p>
                            <p class="campaign-date"><span class="label">Período:</span> ${campaign.periodo || 'A definir'}</p>
                            ${buttonHTML}
                        </div>
                    `;
                    container.innerHTML += cardHTML;
                });
            }
        }

        function loadAllCampaignData() {
            renderActiveCampaigns();
            const planejadas = todasCampanhas.filter(c => c.status === 'planejada');
            renderCompactCampaigns(plannedCampaignsContainer, planejadas, '');
            document.getElementById('countPlanejadasPanel').textContent = planejadas.length;

            const sugeridas = todasCampanhas.filter(c => c.status === 'sugerida');
            renderCompactCampaigns(suggestedCampaignsContainer, sugeridas, 'suggestion-card');
            document.getElementById('countSugeridasPanel').textContent = sugeridas.length;

            const concluidas = todasCampanhas.filter(c => c.status === 'concluida');
            renderCompactCampaigns(concludedCampaignsContainer, concluidas, 'concluded-card', 2);
            document.getElementById('countConcluidasPanel').textContent = concluidas.length;
            if (concluidas.length > 0) noConcludedCampaigns.style.display = 'none'; else noConcludedCampaigns.style.display = 'block';

            addCardButtonListenersToAll();
        }

        function addCardButtonListenersToAll() {
            document.querySelectorAll('.btn-detalhes-campanha, .btn-editar-campanha, .btn-planejar-sugerida').forEach(button => {
                const clonedButton = button.cloneNode(true); // Clonar para remover listeners antigos
                button.parentNode.replaceChild(clonedButton, button);

                clonedButton.addEventListener('click', function () {
                    const card = this.closest('.active-campaign-card, .compact-campaign-card');
                    const campaignId = card.dataset.campaignId;
                    const campaignData = todasCampanhas.find(c => c.id === campaignId);

                    if (this.classList.contains('btn-planejar-sugerida')) {
                        openCampaignModal(campaignData, true, true); // isNewFromSuggestion = true, isSuggestion = true
                    } else if (this.classList.contains('btn-editar-campanha')) {
                        openCampaignModal(campaignData, false, campaignData.status === 'sugerida'); // isNewFromSuggestion = false
                    } else { // Detalhes
                        openCampaignModal(campaignData, false, campaignData.status === 'sugerida', true); // isViewOnly = true
                    }
                });
            });
        }

        function initCampaignMap(containerId = 'campaignFocusMapContainer') {
            if (campaignMap) campaignMap.remove();
            const mapElement = document.getElementById(containerId);
            if (!mapElement) return;

            campaignMap = L.map(containerId).setView([-25.43, -49.27], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(campaignMap);
            setTimeout(() => { if (campaignMap) campaignMap.invalidateSize() }, 100);
        }

        function renderCampaignProgressChartInModal(progress) {
            const chartElement = document.getElementById('campaignProgressChart');
            if (!chartElement) return;
            const ctx = chartElement.getContext('2d');

            if (campaignProgressChartInstance) {
                campaignProgressChartInstance.destroy();
            }

            campaignProgressChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [progress, 100 - progress],
                        backgroundColor: [getComputedStyle(document.documentElement).getPropertyValue('--highlight-color').trim(), getComputedStyle(document.documentElement).getPropertyValue('--bg-medium').trim()],
                        borderWidth: 0, circumference: 180, rotation: 270
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false }, tooltip: { enabled: false } }, animation: { animateScale: true, animateRotate: true } }
            });
        }

        function openCampaignModal(campaignData = null, isNewFromSuggestion = false, isSuggestionBeingPlanned = false, isViewOnly = false) {
            campaignForm.reset();
            iaJustificationContainer.style.display = 'none'; // Esconder por padrão

            const newId = 'C' + Date.now().toString().slice(-5) + Math.random().toString(36).substr(2, 3).toUpperCase();
            document.getElementById('campaignId').value = (campaignData && !isNewFromSuggestion && !isSuggestionBeingPlanned) ? campaignData.id : newId;

            let titleAction = "Nova";
            if (campaignData && !isNewFromSuggestion && !isSuggestionBeingPlanned) {
                titleAction = isViewOnly ? "Detalhes da" : "Editar";
            } else if (isSuggestionBeingPlanned) {
                titleAction = "Planejar";
            }
            modalCampaignTitle.innerHTML = `<i class="fas fa-bullhorn"></i> ${titleAction} Campanha ${isSuggestionBeingPlanned ? "Sugerida pela IA" : ""}`;

            actionsListEditorUl.innerHTML = '';

            if (campaignData) {
                document.getElementById('campaignName').value = campaignData.nome + (isSuggestionBeingPlanned ? ' (Planejamento)' : '');
                document.getElementById('campaignType').value = campaignData.tipo;
                document.getElementById('campaignObjective').value = campaignData.objetivo || '';
                document.getElementById('campaignDoencaAgravo').value = campaignData.doencaAgravo || '';
                document.getElementById('campaignPublicoAlvo').value = campaignData.publico;
                document.getElementById('campaignMetaPrincipal').value = campaignData.meta;

                const today = new Date().toISOString().split('T')[0];
                let startDateStr = campaignData.periodo ? campaignData.periodo.split(' - ')[0] : today;
                let endDateStr = campaignData.periodo ? campaignData.periodo.split(' - ')[1] : today;

                const formatDateForInput = (dateStr) => {
                    if (!dateStr || dateStr === "A definir") return ''; // Deixar vazio se for "A definir"
                    if (dateStr.includes('/')) {
                        const parts = dateStr.split('/');
                        if (parts.length === 3) return `${parts[2]}-${parts[1]}-${parts[0]}`;
                    }
                    return dateStr;
                };

                document.getElementById('campaignStartDate').value = formatDateForInput(startDateStr);
                document.getElementById('campaignEndDate').value = formatDateForInput(endDateStr);
                document.getElementById('campaignStatusModal').value = (isNewFromSuggestion || isSuggestionBeingPlanned) ? 'planejada' : campaignData.status;
                document.getElementById('campaignProgresso').value = campaignData.progresso || 0;

                if (campaignData.acoes && campaignData.acoes.length > 0) {
                    campaignData.acoes.forEach(action => addActionToList(action.desc, formatDateForInput(action.prazo), action.status, action.responsavelSimulado, isViewOnly));
                }

                if ((isSuggestionBeingPlanned || (isViewOnly && campaignData.status === 'sugerida')) && campaignData.justificativaIA) {
                    iaJustificationText.textContent = campaignData.justificativaIA;
                    iaJustificationContainer.style.display = 'block';
                }

            } else { // Nova campanha do zero
                document.getElementById('campaignStartDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('campaignProgresso').value = 0;
                document.getElementById('campaignStatusModal').value = 'planejada';
            }

            // Controlar editabilidade dos campos e botões
            const formElements = campaignForm.elements;
            for (let i = 0; i < formElements.length; i++) {
                formElements[i].disabled = isViewOnly;
            }
            document.getElementById('btnAddAction').style.display = isViewOnly ? 'none' : 'inline-flex';
            document.getElementById('btnSalvarCampanha').style.display = isViewOnly ? 'none' : 'inline-flex';
            if (isViewOnly) { // Esconder botões de remover ação
                actionsListEditorUl.querySelectorAll('.btn-danger').forEach(btn => btn.style.display = 'none');
            }


            renderCampaignProgressChartInModal(parseInt(document.getElementById('campaignProgresso').value) || 0);
            openModal('campaignDetailModal');
            initCampaignMap();
        }

        function addActionToList(desc = '', prazo = '', status = 'planejada', responsavel = '', isViewOnly = false) {
            const li = document.createElement('li');

            if (isViewOnly) {
                li.style.gridTemplateColumns = "3fr 1.5fr 1.5fr 1.5fr"; // Ajustar grid se não houver botão de remover
                li.innerHTML = `
                    <p>${desc || 'N/A'}</p>
                    <p>${prazo ? new Date(prazo + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</p>
                    <p><span class="action-status-display action-status-${status}">${status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span></p>
                    <p>${responsavel || 'N/A'}</p>
                `;
            } else {
                const descInput = document.createElement('input');
                descInput.type = 'text'; descInput.placeholder = 'Descrição'; descInput.value = desc; descInput.name = 'actionDesc[]';

                const prazoInput = document.createElement('input');
                prazoInput.type = 'date'; prazoInput.value = prazo; prazoInput.name = 'actionPrazo[]';

                const responsavelInput = document.createElement('input'); // Novo campo
                responsavelInput.type = 'text'; responsavelInput.placeholder = 'Responsável (Simulado)'; responsavelInput.value = responsavel; responsavelInput.name = 'actionResponsavel[]';

                const statusSelect = document.createElement('select');
                statusSelect.name = 'actionStatus[]';
                ['planejada', 'em_andamento', 'concluida', 'atrasada', 'cancelada'].forEach(sVal => {
                    const option = document.createElement('option');
                    option.value = sVal;
                    option.textContent = sVal.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    if (sVal === status) option.selected = true;
                    statusSelect.appendChild(option);
                });

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button'; removeBtn.classList.add('btn', 'btn-danger', 'btn-sm');
                removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                removeBtn.onclick = () => li.remove();

                li.appendChild(descInput);
                li.appendChild(prazoInput);
                li.appendChild(responsavelInput); // Adicionado
                li.appendChild(statusSelect);
                li.appendChild(removeBtn);
            }
            actionsListEditorUl.appendChild(li);
        }


        btnAddAction.addEventListener('click', () => addActionToList());
        btnNovaCampanha.addEventListener('click', () => openCampaignModal(null, false, false, false)); // Não é sugestão, não é viewOnly

        campaignForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const idInput = document.getElementById('campaignId').value;
            const existingCampaignIndex = todasCampanhas.findIndex(c => c.id === idInput);

            const acoes = [];
            document.querySelectorAll('#actionsListEditor li').forEach(item => {
                // Se estiver em modo de visualização, os inputs não existirão, então não tentamos ler
                if (item.querySelector('input[name="actionDesc[]"]')) {
                    acoes.push({
                        desc: item.querySelector('input[name="actionDesc[]"]').value,
                        prazo: item.querySelector('input[name="actionPrazo[]"]').value,
                        responsavelSimulado: item.querySelector('input[name="actionResponsavel[]"]').value,
                        status: item.querySelector('select[name="actionStatus[]"]').value
                    });
                } else { // Se for modo visualização, pegar os dados dos <p> ou manter os originais
                    const originalCampaign = todasCampanhas.find(c => c.id === idInput);
                    if (originalCampaign && originalCampaign.acoes && originalCampaign.acoes.length > 0) {
                        // Aqui seria mais complexo pegar os dados de volta dos <p>
                        // Por simplicidade, se não for editável, não salvamos as ações, ou mantemos as originais
                        // Para esta versão, vamos manter as ações originais se o modo de edição não estiver ativo para elas
                        // Isso significa que a edição de ações só acontece se o modal foi aberto para edição.
                        // No entanto, a função addActionToList já diferencia a renderização.
                        // A melhor forma é reconstruir as ações a partir dos inputs se existirem.
                    }
                }
            });

            // Se a lista de ações ficou vazia no submit, mas a campanha original tinha ações (e não era para limpar),
            // pode ser necessário buscar as ações originais se o modo ViewOnly estava ativo para a lista de ações.
            // A lógica atual só pega dos inputs, então se ViewOnly escondeu os inputs, acoes[] será vazio.
            // Para este exemplo, vamos assumir que se o formulário é submetido, as ações são as que estão nos inputs.
            // Se o botão de salvar não estivesse visível em ViewOnly, isso não seria um problema.

            const formatDateForDisplay = (dateStr_YYYY_MM_DD) => {
                if (!dateStr_YYYY_MM_DD) return 'A definir';
                const parts = dateStr_YYYY_MM_DD.split('-');
                if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
                return dateStr_YYYY_MM_DD;
            };

            const campaignData = {
                id: idInput,
                nome: document.getElementById('campaignName').value,
                tipo: document.getElementById('campaignType').value,
                objetivo: document.getElementById('campaignObjective').value,
                doencaAgravo: document.getElementById('campaignDoencaAgravo').value,
                publico: document.getElementById('campaignPublicoAlvo').value,
                meta: document.getElementById('campaignMetaPrincipal').value,
                periodo: `${formatDateForDisplay(document.getElementById('campaignStartDate').value)} - ${formatDateForDisplay(document.getElementById('campaignEndDate').value)}`,
                status: document.getElementById('campaignStatusModal').value,
                progresso: parseInt(document.getElementById('campaignProgresso').value),
                acoes: acoes,
                justificativaIA: (todasCampanhas.find(c => c.id === idInput) && todasCampanhas.find(c => c.id === idInput).justificativaIA) || '' // Preservar justificativa se existir
            };

            const isEditing = existingCampaignIndex > -1;
            const wasSuggestion = isEditing && todasCampanhas[existingCampaignIndex].status === 'sugerida';

            if (isEditing && !wasSuggestion) {
                todasCampanhas[existingCampaignIndex] = campaignData;
            } else if (isEditing && wasSuggestion) {
                if (campaignData.status === 'sugerida') {
                    campaignData.status = 'planejada';
                }
                todasCampanhas.splice(existingCampaignIndex, 1);
                todasCampanhas.push(campaignData);
            } else {
                if (campaignData.status === 'sugerida') {
                    campaignData.status = 'planejada';
                }
                todasCampanhas.push(campaignData);
            }

            closeModal('campaignDetailModal');
            loadAllCampaignData();
            alert('Campanha salva com sucesso!');
        });


        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            loadAllCampaignData();

            document.querySelectorAll('.view-all-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const statusFilter = e.target.dataset.statusFilter;
                    alert(`Funcionalidade "Ver todas" para campanhas '${statusFilter}' a ser implementada (ex: levaria para uma lista filtrada).`);
                });
            });
        });

    </script>
</body>

</html>
